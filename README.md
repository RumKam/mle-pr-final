# Проект: Рекомендация товаров в электронной коммерции

## Описание

**Цель:** Предсказать, какие товары предложить пользователю интернет-магазина.

**Основные задачи:** Анализ событий и характеристик товаров, выбор метрик, построение модели рекомендаций, внедрение модели в виде веб-сервиса, мониторинг и обновление модели.

**Данные:** [Ссылка на датасет](https://disk.yandex.ru/d/XPthmNk_pqEDaQ)

**Имя бакета:** s3-student-mle-20240921-750d983cc8

**Описание данных**

1. category_tree.csv — таблица из двух столбцов: «родительская категория» и «дочерняя категория». 
2. events.csv — таблица с логом событий:
    - timestamp — временная метка события,
    - visitorid — идентификатор пользователя,
    - event — событие (просмотр, добавление в корзину, покупка),
    - itemid — идентификатор товара,
    - transactionid — идентификатор транзакции (покупки).
3. item_properties.csv — таблица со свойствами товаров:
    - timestamp — временная метка добавления свойства,
    - itemid — идентификатор товара,
    - property — свойство товара,
    - value — значение свойства.

## Подготовка виртуальной машины

Склонировать репозиторий проекта:
```
git clone [<ссылка-репозиторий>](https://github.com/RumKam/mle-pr-final.git)

Перейтив папку проекта
cd mle-pr-final
```
Создать новое виртуальное окружение можно командами:

Обновление локального индекса пакетов
```
sudo apt-get update
```
Установка расширения для виртуального пространства
```
sudo apt-get install python3.10-venv
```
Создание виртуального пространства
```
python3.10 -m venv .venv_pr_final
```

Инициализацировать окружение
```
source .venv_pr_final/bin/activate
```
Установить в него необходимые Python-пакеты следующей командой

```
pip install -r requirements.txt
```

## Руководство к проекту

### Трансляция бизнес-задачи в техническую задачу. 

Задача заключается в том, чтобы увеличить количество добавлений товаров в корзину с помощью рекомендаций. Это подразумевает, что мы должны понимать предпочтения пользователей и предлагать им товары, которые они с высоким шансом захотят добавить в корзину. При этом важно учитывать, что некоторые действия, такие как покупки, могут служить индикаторами интересов пользователей.

Выбранная метрика: Количество добавлений в корзину. Это основная метрика, которую будем стремиться максимизировать. Она напрямую отражает успех просчитанных рекомендаций.

Для развития проекта можно рассмотреть также метрики:
- Конверсия из просмотра в добавление в корзину. Насколько эффективно мы превращаем просмотры товаров в добавления в корзину.
- Частота покупок. Как часто пользователи, добавляющие товары в корзину, затем совершают покупки.

### Разворачивание инфраструктуры обучения модели.

Для разворачивания MLflow и остальной инфраструктуры, необходимой для обучения моделей, были выполнены следующие шаги:

1. Установка MLflow и его зависимостей.
2. Настройка серверной части MLflow для хранения метрик и моделей.

**Тетрадка с исследованием и обучением модели:** mle-pr-final/notebooks/main_research.ipynb

Для запуска MLFlow необходимо перейти в папку с shell файлом
```
cd mlflow_server
```
Далее запустить сервер командой 
```
sh run_mlflow.sh
```

**Параметры эксперимента**

EXPERIMENT_NAME = 'pr_final_#2'
REGISTRY_MODEL_NAME = "ranking_model"

### Проведение EDA

**Ключевые шаги проведения Exploratory Data Analysis (EDA):**

1. Анализ временной динамики: выявление пиков взаимодействий пользователей в течение недели и месяца.
2. Временные характеристики: изучение взаимодействий в течение дня для понимания поведения пользователей.
3. Баланс действий: оценка соотношения просмотров и добавлений в корзину для выявления проблем в конверсии.
4. Анализ распределения добавлений: изучение распределения добавленных товаров на пользователя, выявление выбросов.
5. Сравнение популярности товаров: анализ топа просмотренных и добавленных в корзину товаров для выявления различий.
6. Проблемы с отсутствием данных: оценка отсутствующих признаков и их влияние на анализ.

**Выводы по EDA:**
1. Взаимодействия пользователей имеют выраженную временную динамику.
2. Низкий уровень целевых действий (добавление в корзину) требует внимания.
3. Необходимость дальнейшего анализа поведения пользователей и товаров.

**Гипотезы:**
1. Активность пользователей в начале недели связана с новыми акциями.
2. Утренние часы характеризуются низким уровнем взаимодействий.
3. Низкий уровень добавлений может быть следствием недостаточной привлекательности товаров.
4. Высокая активность некоторых пользователей требует углубленного анализа их интересов.
5. Низкий уровень добавлений товаров в корзину может быть связан с несоответствием товарных характеристик потребностям пользователей.


### Генерация признаков и обучение модели. Укажите, какие признаки сгенерировались и как это повлияло на модель. Опишите, что можно увидеть в запусках в MLflow.

1. --/--

### Разворачивание инфраструктуры применения модели.

Процесс запуска веб-сервиса и дополнительной инфраструктуры включает:

1. Настройка веб-сервиса для предоставления рекомендаций пользователям.

**Запуск сервиса рекомендаций**

команда перехода в нужную директорию
```
cd mle-pr-final/app
```
команда для запуска микросервиса в режиме docker compose
```
docker compose up  --build
```
команда остановки микросервиса
```
docker compose down
```
перед повторным запуском микросервиса убедитесь в том, что микросервис остановлен
```
docker compose ls
```

2. Настройка системы мониторинга для отслеживания производительности модели. Запускается совместно с основным сервисом.
3. Создание Airflow-графа для автоматизации обновления модели и обработки данных. Поднимаетсч в отдельном контейнере.

Даг обработки данных и обучения модели:
/mle-pr-final/airflow/dags/train_model.py

Шаги дага:
/mle-pr-final/airflow/plugins/steps/train_model.py

Отправка статусов в телеграмм:
/mle-pr-final/airflow/plugins/steps/messages.py

команда перехода в нужную директорию
```
cd mle-pr-final/airflow
```
команда для запуска микросервиса в режиме docker compose
```
docker compose up  --build
```
команда остановки микросервиса
```
docker compose down
```
перед повторным запуском микросервиса убедитесь в том, что микросервис остановлен
```
docker compose ls
```

#### Пример работы сервиса

**Пример запроса**

```
curl -X 'POST' \
  'http://172.20.0.1:8000/recommendations/?user_id=1&k=5' \
  -H 'accept: application/json' \
  -H 'Content-Type: application/json' \
  -d ''
```

**Скрипт для симуляции запросов**

Скрипт генерирует 5 запросов с рандомным тайм-аутом от 0,01 до 1 секунды

Команды, необходимые для запуска скрипта
```
python test_recsys.py
```

Адреса сервисов:
- микросервис: http://172.20.0.1:8000
- Prometheus: http://172.20.0.1:9090