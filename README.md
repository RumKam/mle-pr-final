# Проект: Рекомендация товаров в электронной коммерции

## Описание

**Цель:** Предсказать, какие товары предложить пользователю интернет-магазина.

**Основные задачи:** Анализ событий и характеристик товаров, выбор метрик, построение модели рекомендаций, внедрение модели в виде веб-сервиса, мониторинг и обновление модели.

**Имя бакета:** s3-student-mle-20240921-750d983cc8

**Структура проекта**

mle-pr-final/ 
├── airflow/             -- файлы сервиса Airflow
│ ├── config/ 
│ ├── dags/ 
│ ├── logs/ 
│ └── plugins/
│    └── steps/
├── app/                 -- основное приложение
│ ├── data/              -- локальное сохранение данных
│ ├── events_service/    -- побочный сервис, принимает онлайн действия пользователя
│ ├── features_service/  -- побочный сервис, определяет похожие товары
│ ├── Prometheus/        -- сервис мониторинга метрик
│ ├── recommendations/   -- локальное сохранение рекомендаций
│ └── recsys_service/    -- основной сервис, выдающий рекомендации
├── mlflow_server/       -- сервис логирования артефактов     
├── models/              -- локальное сохранение моделей
└── notebooks/           -- juputer nootbok с исследованием и обученим модели

**Описание данных**

1. category_tree.csv — таблица из двух столбцов: «родительская категория» и «дочерняя категория». 
2. events.csv — таблица с логом событий:
    - timestamp — временная метка события,
    - visitorid — идентификатор пользователя,
    - event — событие (просмотр, добавление в корзину, покупка),
    - itemid — идентификатор товара,
    - transactionid — идентификатор транзакции (покупки).
3. item_properties.csv — таблица со свойствами товаров:
    - timestamp — временная метка добавления свойства,
    - itemid — идентификатор товара,
    - property — свойство товара,
    - value — значение свойства.

## Подготовка виртуальной машины

Склонировать репозиторий проекта:
```
git clone [<ссылка-репозиторий>](https://github.com/RumKam/mle-pr-final.git)
```
Перейтив папку проекта
```
cd mle-pr-final
```
Создать новое виртуальное окружение можно командами:

Обновление локального индекса пакетов
```
sudo apt-get update
```

Установка расширения для виртуального пространства
```
sudo apt-get install python3.10-venv
```

Создание виртуального пространства
```
python3.10 -m venv .venv_pr_final
```
Инициализацировать окружение
```
source .venv_pr_final/bin/activate
```

Установить в него необходимые Python-пакеты следующей командой
```
pip install -r requirements.txt
```

Дополнительно необходимо устновить следующую зависимость для запуска MLflow
```
pip install psycopg && pip install 'psycopg[binary]'
```

## Руководство к проекту

### Трансляция бизнес-задачи в техническую задачу. 

Задача заключается в том, чтобы увеличить количество добавлений товаров в корзину с помощью рекомендаций. Это подразумевает, что мы должны понимать предпочтения пользователей и предлагать им товары, которые они с высоким шансом захотят добавить в корзину. При этом важно учитывать, что некоторые действия, такие как покупки, могут служить индикаторами интересов пользователей.

Выбранная метрика: Количество добавлений в корзину. Это основная метрика, которую будем стремиться максимизировать. Она напрямую отражает успех просчитанных рекомендаций.

Для развития проекта можно рассмотреть также метрики:
- Конверсия из просмотра в добавление в корзину. Насколько эффективно мы превращаем просмотры товаров в добавления в корзину.
- Частота покупок. Как часто пользователи, добавляющие товары в корзину, затем совершают покупки.

### Разворачивание инфраструктуры обучения модели.

Для разворачивания MLflow и остальной инфраструктуры, необходимой для обучения моделей, были выполнены следующие шаги:

1. Установка MLflow и его зависимостей.
2. Настройка серверной части MLflow для хранения метрик и моделей.

Чтобы запуск MLFlow осуществился, при первом запуске необходимо перейти в папку с shell файлом
```
cd mlflow_server
```

Далее дать разрешение на чтение кредов
```
export $(cat .env | xargs)
```

**Тетрадка с исследованием и обучением модели:** mle-pr-final/notebooks/main_research.ipynb

**Параметры эксперимента**

- EXPERIMENT_NAME = 'pr_final_#2'
- REGISTRY_MODEL_NAME = "ranking_model"
- Experiment ID: 24

### Проведение EDA

**Ключевые шаги проведения Exploratory Data Analysis (EDA):**

1. Анализ временной динамики: выявление пиков взаимодействий пользователей в течение недели и месяца.
2. Временные характеристики: изучение взаимодействий в течение дня для понимания поведения пользователей.
3. Баланс действий: оценка соотношения просмотров и добавлений в корзину для выявления проблем в конверсии.
4. Анализ распределения добавлений: изучение распределения добавленных товаров на пользователя, выявление выбросов.
5. Сравнение популярности товаров: анализ топа просмотренных и добавленных в корзину товаров для выявления различий.
6. Проблемы с отсутствием данных: оценка отсутствующих признаков и их влияние на анализ.

**Выводы по EDA:**
1. Взаимодействия пользователей имеют выраженную временную динамику.
2. Низкий уровень целевых действий (добавление в корзину) требует внимания.
3. Необходимость дальнейшего анализа поведения пользователей и товаров.

**Гипотезы:**
1. Активность пользователей в начале недели связана с новыми акциями.
2. Утренние часы характеризуются низким уровнем взаимодействий.
3. Низкий уровень добавлений может быть следствием недостаточной привлекательности товаров.
4. Высокая активность некоторых пользователей требует углубленного анализа их интересов.
5. Низкий уровень добавлений товаров в корзину может быть связан с несоответствием товарных характеристик потребностям пользователей.


### Генерация признаков и обучение модели

1. RUN_NAME = 'recsys_encoders'
   - кодирование категориальных признаков categiryid, parentid, userid и itemid
2. RUN_NAME = 'recsys_top_popular_recs'
   - создание рекомендаций для холодных пользователей: топ-50 просаматриваемых товаров
3. RUN_NAME = 'recsys_similar_items'
   - матрица похожих товаров
4. RUN_NAME = 'recsys_final_recs'
   - персональные рекомендации на основе ранжирования вероятности добавления товара в корзину
   - модель Catboost с таргетом: 1 - товар добавлен в корзину, 0 - товар не был добавлен в корзину
5. RUN_NAME = 'recsys_final_metrics'
   - логирование метрик для двух видов рекомендаций: топ-50 по умолчанию и персональные рекомендации для пользователей с историей

Сгенерированы новые признаки:
- istransaction - факт совершения покупки
- available - доступность товара
- rating - отмасштабированный признак популярности товара по количеству просмотров
- day_of_week - день недели, в который было совершено действие
- day - день, в который было совершено действие
- hour - час, в который было совершено действие

Добавление признаков: день недели, день и час были добавлены по результатам EDA. В действиях пользователей наблюдается сезонность, поэтому такие признаки способствуют улучшению прогноза.

### Разворачивание инфраструктуры применения модели.

Процесс запуска веб-сервиса и дополнительной инфраструктуры включает:

1. Настройка веб-сервиса для предоставления рекомендаций пользователям.
2. Настройка системы мониторинга для отслеживания производительности модели. Запускается совместно с основным сервисом.
3. Создание Airflow-графа для автоматизации обновления модели и обработки данных. Поднимается в отдельном контейнере.

Даг обработки данных и обучения модели:
/mle-pr-final/airflow/dags/train_model.py

Шаги дага:
/mle-pr-final/airflow/plugins/steps/train_model.py

Отправка статусов в телеграмм:
/mle-pr-final/airflow/plugins/steps/messages.py

Для запуска приложения необходимо использовать shell скрипт:

```
sh start_app.sh
```

Предварительно необходимо дать права, выполнив команду в терминале:
```
chmod +x start_app.sh
```

и для MLflow
```
chmod +x mle-pr-final/mlflow_server/start_mlflow.sh
```


#### Пример работы сервиса

**Пример запроса**

```
curl -X 'POST' \
  'http://172.20.0.1:8000/recommendations/?user_id=1&k=5' \
  -H 'accept: application/json' \
  -H 'Content-Type: application/json' \
  -d ''
```

**Скрипт для симуляции запросов**

Скрипт генерирует 5 запросов с рандомным тайм-аутом от 0,01 до 1 секунды

Команда, необходимые для запуска скрипта:
```
python test_recsys.py
```
Логи теста в файле *test_service.log*


Адреса сервисов:
- [Приложение](http://172.20.0.1:8000)
- [Prometheus](http://172.20.0.1:9090)
- [Mlflow](http://172.20.0.1:8000)
- [Airflow](http://172.20.0.1:8080)
